---
build:composer:
  stage: prepare
  image: registry.gitlab.com/stayallive/php:$PHP_VERSION
  needs:
    - job: integrity:verify
  before_script:
    - composer config --global --auth http-basic.tde.repo.repman.io token "$COMPOSER_REPMAN_TOKEN"
    - composer config --global github-oauth.github.com "$GITHUB_AUTH_TOKEN"
  script:
    - '[[ ! -f composer.json ]] && exit 0'
    - COMPOSER_CACHE_DIR=composer-cache composer install --verbose --prefer-dist
      --no-progress --no-interaction --no-dev --optimize-autoloader --no-scripts
      --ignore-platform-reqs
  cache:
    - key: composer-package-cache
      paths:
        - composer-cache/
      policy: pull-push
      unprotect: true
    - key:
        files:
          - composer.lock
        prefix: composer-vendors
      paths:
        - $VENDOR_FOLDER
      policy: pull-push
      unprotect: true
    - key: integrity-$CI_COMMIT_REF_NAME-build-$CI_JOB_NAME
      paths:
        - .integrity_vendor_missing
      policy: pull
      unprotect: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /CI_BUILD/
      when: always
    - exists:
        - .integrity_vendor_missing
      when: on_success
    - changes:
        - composer.json
        - composer.lock
      when: always
