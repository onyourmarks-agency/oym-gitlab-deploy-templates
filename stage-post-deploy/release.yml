release:production:
  stage: post-deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  variables:
    GIT_STRATEGY: none
  needs:
    - job: deploy:production
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - when: on_success
  script:
    - apk add curl
    - "PREVIOUS_RELEASE=$(curl -Ls -o /dev/null -w %{url_effective} --header \"JOB-TOKEN: $CI_JOB_TOKEN\" \"$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/permalink/latest\" | tail -c 8 2> /dev/null)"
    - "release-cli create --tag-name $CI_COMMIT_SHORT_SHA --name \"'Release $CI_COMMIT_REF_NAME - $CI_COMMIT_SHORT_SHA\" --description \"Release $CI_COMMIT_SHORT_SHA\" --assets-link \"[{\\\"name\\\": \\\"Build pipeline\\\",\\\"url\\\": \\\"$CI_PIPELINE_URL\\\"},{\\\"name\\\": \\\"Full changelog\\\",\\\"url\\\": \\\"$CI_PROJECT_URL/-/compare/$PREVIOUS_RELEASE...$CI_COMMIT_SHORT_SHA\\\"}]\""
