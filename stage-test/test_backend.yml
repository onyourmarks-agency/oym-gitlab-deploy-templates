---
test_backend:
  stage: test
  variables:
    GIT_STRATEGY: fetch
  needs:
    - job: composer_install
      artifacts: true
      optional: true
  script:
    - 'phpcs --error-severity=$PHPCS_ERROR_SEVERITY --warning-severity=$PHPCS_WARNING_SEVERITY --extensions=php'
  rules:
    - if: '$PHPCS_MODE == "strict"'
      changes:
        - composer.json
        - composer.lock
        - modules/*
        - modules/**/*
        - src/*
        - src/**/*
      when: on_success
    - if: '$PHPCS_MODE == "relaxed"'
      changes:
        - composer.json
        - composer.lock
        - modules/*
        - modules/**/*
        - src/*
        - src/**/*
      allow_failure: true
      when: on_success
    - if: '$CI_COMMIT_MESSAGE =~ /CI_BUILD/ && $PHPCS_MODE == "strict"'
      allow_failure: false
      when: on_success
    - if: '$CI_COMMIT_MESSAGE =~ /CI_BUILD/ && $PHPCS_MODE == "relaxed"'
      allow_failure: true
      when: on_success
    - if: '$PHPCS_MODE == "disabled"'
      when: never
