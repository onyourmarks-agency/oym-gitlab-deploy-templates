phpstan:
  image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
  stage: test
  variables:
    GIT_STRATEGY: fetch
  needs:
    - job: composer_install
      artifacts: true
      optional: true
  script:
    - 'phpstan analyse  --memory-limit=2G'
  rules:
    - if: '$PHPSTAN_MODE == "strict"'
      changes:
        - composer.json
        - composer.lock
        - modules/*
        - modules/**/*
        - src/*
        - src/**/*
      allow_failure: true
      when: on_success
    - if: '$PHPSTAN_MODE == "relaxed"'
      changes:
        - composer.json
        - composer.lock
        - modules/*
        - modules/**/*
        - src/*
        - src/**/*
      allow_failure: true
      when: on_success
    - if : '$CI_COMMIT_MESSAGE =~ /CI_BUILD/ && $PHPSTAN_MODE == "strict"'
      allow_failure: false
      when: on_success
    - if : '$CI_COMMIT_MESSAGE =~ /CI_BUILD/ && $PHPSTAN_MODE == "relaxed"'
      allow_failure: true
      when: on_success
    - if: '$PHPSTAN_MODE == "disabled"'
      when: never

